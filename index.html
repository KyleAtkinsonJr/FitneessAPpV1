<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fitness Tracker</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="data:," />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Annotation Plugin for target line -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    /* Custom styles for the timer and general aesthetics */
    body {
      font-family: 'Inter', sans-serif;
    }
    .timer-container {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
      font-weight: bold;
      color: #ef4444; /* Red for active timer */
    }
    .timer-container.hidden {
      display: none;
    }
    .timer-circle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #ef4444;
      margin-right: 8px;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      from { transform: scale(0.8); opacity: 0.7; }
      to { transform: scale(1); opacity: 1; }
    }
    .arrow-icon {
      margin-left: 4px;
      display: inline-block;
      vertical-align: middle;
    }
    .arrow-up { color: #22c55e; } /* green-500 */
    .arrow-down { color: #ef4444; } /* red-500 */
    .arrow-same { color: #6b7280; } /* gray-500 */

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      max-width: 700px; /* Increased max-width for charts */
      width: 90%;
      position: relative;
      max-height: 90vh; /* Limit height for scrollability */
      overflow-y: auto; /* Enable scrolling for content */
    }
    .modal-close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #6b7280;
    }

    /* Rest Timer Pop-up specific styles */
    .rest-timer-popup {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ef4444; /* Red */
      color: white;
      padding: 1rem 2rem;
      border-radius: 9999px; /* Fully rounded */
      font-size: 2.5rem; /* Larger font */
      font-weight: bold;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 1100; /* Above other modals */
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInOut 0.5s ease-in-out;
    }

    @keyframes fadeInOut {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    /* Highlight for moved/swapped days */
    .highlight-day {
      background-color: #a78bfa !important; /* purple-400 */
      color: white !important;
      animation: highlightPulse 0.8s ease-in-out infinite alternate;
    }

    @keyframes highlightPulse {
      from { box-shadow: 0 0 0 0 rgba(167, 139, 250, 0.7); }
      to { box-shadow: 0 0 0 8px rgba(167, 139, 250, 0); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 text-gray-900 font-sans min-h-screen flex items-center justify-center py-8">
  <div id="root" class="w-full max-w-3xl mx-auto p-4"></div>

  <!-- React, ReactDOM (development-only for `createRoot`) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;
    const createRoot = ReactDOM.createRoot;

    // --- Utility Functions ---
    const getWeekNumber = (date) => {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };

    const formatDate = (date) => date.toISOString().split('T')[0]; // YYYY-MM-DD
    const getDayName = (date) => {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      return days[date.getDay()];
    };

    const getDayIndex = (dayName) => {
      const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      return days.indexOf(dayName);
    };

    const getStartOfWeek = (date) => {
      const d = new Date(date);
      const day = d.getDay(); // 0 for Sunday, 1 for Monday
      const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
      return new Date(d.setDate(diff));
    };

    const addDays = (date, days) => {
      const result = new Date(date);
      result.setDate(result.getDate() + days);
      return result;
    };

    const getDaysInMonth = (year, month) => {
      return new Date(year, month + 1, 0).getDate();
    };

    // --- Constants ---
    const MOTIVATION_QUOTES = [
      "The only bad workout is the one that didn't happen.",
      "Push yourself because no one else is going to do it for you.",
      "Success is earned one rep at a time.",
      "Believe you can and you're halfway there.",
      "The body achieves what the mind believes.",
      "Strength does not come from physical capacity. It comes from an indomitable will.",
      "Your body can stand almost anything. It's your mind that you have to convince.",
      "The pain you feel today will be the strength you feel tomorrow."
    ];

    // Common exercises for customization - EXPANDED LIST
    const ALL_EXERCISES = [
      // Strength - Lower Body (Glute Focus)
      { id: 'barbell-hip-thrusts', name: 'Barbell Hip Thrusts', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=Zp26q4BY5HE' }, // Girls Gone Strong
      { id: 'dumbbell-rdls', name: 'Dumbbell Romanian Deadlifts', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=08StUopZee8' }, // Women's Strength Nation
      { id: 'goblet-squats', name: 'Goblet Squats', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=C3b0lvMH0gk' }, // Girls Gone Strong
      { id: 'cable-glute-kickbacks', name: 'Cable Glute Kickbacks', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=SqO-VUEak2M' }, // PureGym
      { id: 'bulgarian-split-squats', name: 'Bulgarian Split Squats (Dumbbell)', sets: 3, reps: 8, videoUrl: 'https://www.youtube.com/watch?v=HLMT0tDpPII' }, // Weighted Dumbbell Bulgarian Split Squat
      { id: 'cable-pull-throughs', name: 'Cable Pull-Throughs', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=H7mYm33zWpE' }, // Good generic one
      { id: 'leg-press', name: 'Leg Press', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=p5dCqF7wWUw' }, // PureGym
      { id: 'seated-calf-raises', name: 'Seated Calf Raises', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=3ZRe_QpvRPg' }, // PureGym
      { id: 'glute-bridges', name: 'Dumbbell Glute Bridges', sets: 3, reps: 15, videoUrl: 'https://www.puregym.com/exercises/glutes/glute-bridge/dumbbell-glute-bridges/' }, // PureGym
      { id: 'sumo-squats', name: 'Dumbbell Sumo Squats', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=KecS-01uVK0' }, // Train Like A Warrior
      { id: 'reverse-hyperextensions', name: 'Reverse Hyperextensions (Bench)', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=d9ZFBdWFZSQ' }, // Steph Gaudreau
      { id: 'banded-lateral-walks', name: 'Banded Lateral Walks', sets: 3, duration: '10-15 steps each side', videoUrl: 'https://www.youtube.com/watch?v=i0w7KczRvkk' }, // Rehab My Patient
      { id: 'step-ups', name: 'Dumbbell Step-ups', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=DxUNi119Qzs' }, // PureGym
      { id: 'single-leg-rdls', name: 'Single-Leg RDLs (Dumbbell)', sets: 3, reps: 8, videoUrl: 'https://www.youtube.com/watch?v=jW01e61j35Q' }, // Bodybuilding.com
      { id: 'hyperextensions', name: 'Hyperextensions (Back Extension)', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=ph3pddpKzzw' }, // Good generic one
      { id: 'donkey-kicks', name: 'Donkey Kicks (Banded)', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=SJ1Xuz9D-ZQ' }, // Livestrong Woman
      { id: 'glute-medius-kickbacks', name: 'Glute Medius Kickbacks (Cable)', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=Qh_tX1g3aXk' }, // Good generic one
      { id: 'banded-clam-shells', name: 'Banded Clam Shells', sets: 3, reps: 20, videoUrl: 'https://www.youtube.com/watch?v=39vuP5xozsI' }, // Clams Exercise Demonstration
      // New Bodyweight Squats
      { id: 'bodyweight-squats', name: 'Bodyweight Squats', sets: 3, reps: 20, videoUrl: 'https://www.youtube.com/watch?v=GCs2vN_y-14' },
      // Strength - Upper Body (Push)
      { id: 'incline-pushups', name: 'Incline Push-ups', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=yAbg3_pJKvw' }, // PureGym
      { id: 'dumbbell-shoulder-press', name: 'Dumbbell Shoulder Press', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=seUCEgPsBtc' }, // MrSupplement
      { id: 'dumbbell-chest-press', name: 'Dumbbell Chest Press', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=X3YrlBmjWrY' }, // Livestrong Woman
      { id: 'tricep-extensions', name: 'Overhead Tricep Extensions (Dumbbell)', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=YM8iX9BJWjA' }, // Women's Strength Nation
      { id: 'dumbbell-incline-press', name: 'Dumbbell Incline Press', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=cRconFeJ68g' }, // MrSupplement
      { id: 'arnold-press', name: 'Arnold Press', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=fFyrgCWTIaI' }, // BODi - Lita Lewis
      { id: 'cable-flyes', name: 'Cable Flyes', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=KwvJEXts2lg' }, // Physique Development
      { id: 'tricep-pushdowns', name: 'Tricep Pushdowns (Cable)', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=d_Kz7-y11G4' }, // PureGym
      // Strength - Upper Body (Pull)
      { id: 'lat-pulldowns', name: 'Lat Pulldowns', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=j9jtjL8FhPI' },
      { id: 'dumbbell-rows', name: 'Bent-Over Dumbbell Rows', sets: 3, reps: 10, videoUrl: 'https://www.mayoclinic.org/healthy-lifestyle/fitness/multimedia/bent-over-row/vid-20084680' },
      { id: 'face-pulls', name: 'Face Pulls', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=ntBwG1E3Pzs' },
      { id: 'bicep-curls', name: 'Bicep Curls (Dumbbell)', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=Nkl8WnH6tDU' },
      { id: 'seated-cable-rows', name: 'Seated Cable Rows', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=GZ0b_E-tQ0w' },
      { id: 'pull-aparts', name: 'Banded Face Pulls / Pull-Aparts', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=uX5W2kynMIo' },
      { id: 'hammer-curls', name: 'Hammer Curls', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=EWWKFb0q0Uc' },
      { id: 'assisted-pullups', name: 'Assisted Pull-ups', sets: 3, reps: 8, videoUrl: 'https://www.youtube.com/watch?v=wFj808u2HWU' },
      { id: 'dumbbell-pullovers', name: 'Dumbbell Pullovers', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=tM-RjVia9AY' },
      // Core
      { id: 'plank', name: 'Plank', sets: 3, duration: '30-60 sec hold', videoUrl: 'https://www.youtube.com/watch?v=p35_S284G00' },
      { id: 'ab-crunches', name: 'Ab Crunches', sets: 3, reps: 20, videoUrl: 'https://www.youtube.com/watch?v=Xyd_fa5zo6M' },
      { id: 'russian-twists', name: 'Russian Twists', sets: 3, reps: 20, videoUrl: 'https://www.youtube.com/watch?v=ultWZbPWptQ' },
      // Cardio
      { id: 'elliptical-cardio', name: 'Elliptical / Brisk Walk', duration: '45-60 min Steady State', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=cZp91N_W69Q' },
      { id: 'hiit-sprints', name: 'HIIT Sprints (Treadmill/Bike)', duration: '20-30 min Intervals', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=l_aB0m-Vf9s' },
      { id: 'yoga-stretch', name: 'Yoga / Stretching', duration: '30-45 min', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=g_tfX_197L0' },
      { id: 'long-walk', name: 'Long Walk', duration: '60 min', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=tjXw24X2z7o' },
      { id: 'jumping-jacks', name: 'Jumping Jacks', sets: 3, duration: '60 sec', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=i_f4S4y4s0c' },
      { id: 'mountain-climbers', name: 'Mountain Climbers', sets: 3, duration: '60 sec', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=nmwGFXGTmXk' },
      { id: 'cycle-cardio', name: 'Cycling (Moderate Intensity)', duration: '30 min', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=b4w_J4S_g8Q' },
      { id: 'dance-cardio', name: 'Dance Cardio', duration: '30 min', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=v72x6x-3_3c' },
      { id: 'spin-class', name: 'Spin Class', duration: '45-60 min', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=l_aB0m-Vf9s' },
      { id: 'swimming', name: 'Swimming', duration: '30-45 min', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=Yf1e_yQ41k4' }
    ];

    const WORKOUT_PLANS = {
      'ppl_split_plan': {
        name: 'Push, Pull, Legs Split',
        description: 'A classic training split focusing on muscle groups for strength and growth.',
        schedule: {
          'Mon': [ // Push Day
            { id: 'dumbbell-chest-press', name: 'Dumbbell Chest Press', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=X3YrlBmjWrY' },
            { id: 'dumbbell-shoulder-press', name: 'Dumbbell Shoulder Press', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=seUCEgPsBtc' },
            { id: 'dumbbell-incline-press', name: 'Dumbbell Incline Press', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=cRconFeJ68g' },
            { id: 'tricep-extensions', name: 'Overhead Tricep Extensions (Dumbbell)', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=YM8iX9BJWjA' },
            { id: 'cable-flyes', name: 'Cable Flyes', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=KwvJEXts2lg' },
            { id: 'plank', name: 'Plank', sets: 3, duration: '30-60 sec hold', videoUrl: 'https://www.youtube.com/watch?v=p35_S284G00' }
          ],
          'Tue': [ // Pull Day
            { id: 'lat-pulldowns', name: 'Lat Pulldowns', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=j9jtjL8FhPI' },
            { id: 'dumbbell-rows', name: 'Bent-Over Dumbbell Rows', sets: 3, reps: 10, videoUrl: 'https://www.mayoclinic.org/healthy-lifestyle/fitness/multimedia/bent-over-row/vid-20084680' },
            { id: 'face-pulls', name: 'Face Pulls', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=ntBwG1E3Pzs' },
            { id: 'bicep-curls', name: 'Bicep Curls (Dumbbell)', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=Nkl8WnH6tDU' },
            { id: 'seated-cable-rows', name: 'Seated Cable Rows', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=GZ0b_E-tQ0w' },
            { id: 'ab-crunches', name: 'Ab Crunches', sets: 3, reps: 20, videoUrl: 'https://www.youtube.com/watch?v=Xyd_fa5zo6M' }
          ],
          'Wed': [ // Legs Day
            { id: 'barbell-hip-thrusts', name: 'Barbell Hip Thrusts', sets: 3, reps: 10, videoUrl: 'https://www.youtube.com/watch?v=Zp26q4BY5HE' },
            { id: 'dumbbell-rdls', name: 'Dumbbell Romanian Deadlifts', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=08StUopZee8' },
            { id: 'goblet-squats', name: 'Goblet Squats', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=C3b0lvMH0gk' },
            { id: 'bulgarian-split-squats', name: 'Bulgarian Split Squats (Dumbbell)', sets: 3, reps: 8, videoUrl: 'https://www.youtube.com/watch?v=HLMT0tDpPII' },
            { id: 'leg-press', name: 'Leg Press', sets: 3, reps: 12, videoUrl: 'https://www.youtube.com/watch?v=p5dCqF7wWUw' },
            { id: 'seated-calf-raises', name: 'Seated Calf Raises', sets: 3, reps: 15, videoUrl: 'https://www.youtube.com/watch?v=3ZRe_QpvRPg' }
          ],
          'Thu': [ // Cardio Day
            { id: 'elliptical-cardio', name: 'Elliptical / Brisk Walk', duration: '45-60 min Steady State', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=cZp91N_W69Q' }
          ],
          'Fri': [ // Active Recovery
            { id: 'yoga-stretch', name: 'Yoga / Stretching', duration: '30-45 min', type: 'cardio', videoUrl: 'https://www.youtube.com/watch?v=g_tfX_197L0' }
          ],
          'Sat': [], // Rest Day
          'Sun': []  // Rest Day
        }
      }
    };

    // Mapping for workout type to emoji icon
    const WORKOUT_TYPE_ICONS = {
      'Push Day': '🏋️‍♀️',
      'Pull Day': '💪',
      'Legs Day': '🦵',
      'Cardio': '🏃‍♀️',
      'Active Recovery': '🧘‍♀️',
      'Rest Day': '😴',
      'Custom Workout': '✨'
    };


    // --- Chart Component ---
    const ChartComponent = ({ type, data, options }) => {
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      useEffect(() => {
        // Ensure Chart.js and plugin are loaded globally
        // This check is now primarily for safety, the parent component handles conditional rendering
        if (typeof Chart === 'undefined' || typeof ChartAnnotation === 'undefined') {
          console.error("Chart.js or Chart.js Annotation plugin not loaded in ChartComponent.");
          return;
        }

        if (chartInstance.current) {
          chartInstance.current.destroy(); // Destroy existing chart before re-rendering
        }

        if (chartRef.current) {
          const ctx = chartRef.current.getContext('2d');
          // Register the plugin if it hasn't been already
          if (!Chart.plugins.get('annotation')) {
            Chart.register(ChartAnnotation);
          }

          chartInstance.current = new Chart(ctx, {
            type: type,
            data: data,
            options: options,
          });
        }

        return () => {
          if (chartInstance.current) {
            chartInstance.current.destroy();
          }
        };
      }, [data, options, type]); // Re-render chart if data, options, or type changes

      return <canvas ref={chartRef}></canvas>;
    };

    // --- Calendar Component ---
    const Calendar = ({ currentWeekStart, selectedDate, onSelectDay, onPrevWeek, onNextWeek, workoutPlans, selectedPlanId, allWorkoutData, highlightedDate }) => {
      const days = [];
      let currentDay = new Date(currentWeekStart);

      // Function to determine the workout type for a given day
      const getWorkoutTypeForDay = (date) => {
          const dayName = getDayName(date);
          const dateKey = formatDate(date);

          const customizedExercises = allWorkoutData[dateKey]?.exercises;
          const hasCustomExercises = Array.isArray(customizedExercises) && customizedExercises.length > 0;
          const wasCustomizedButEmpty = Array.isArray(customizedExercises) && customizedExercises.length === 0;

          if (hasCustomExercises) {
              return 'Custom Workout';
          }

          const plannedExercises = workoutPlans[selectedPlanId]?.schedule[dayName];

          if (wasCustomizedButEmpty || !plannedExercises || plannedExercises.length === 0) {
              return 'Rest Day';
          }

          // Infer type from day name for the PPL split
          switch (dayName) {
              case 'Mon': return 'Push Day';
              case 'Tue': return 'Pull Day';
              case 'Wed': return 'Legs Day';
              case 'Thu': return 'Cardio';
              case 'Fri': return 'Active Recovery';
              case 'Sat':
              case 'Sun': return 'Rest Day';
              default: return 'Workout';
          }
      };


      for (let i = 0; i < 7; i++) {
        const day = new Date(currentDay);
        const isSelected = formatDate(day) === formatDate(selectedDate);
        const today = formatDate(new Date()) === formatDate(day);
        const dayType = getWorkoutTypeForDay(day); // Get the workout type for the day
        const dayIcon = WORKOUT_TYPE_ICONS[dayType]; // Get the icon for the workout type
        const isHighlighted = formatDate(day) === highlightedDate;

        days.push(
          <button
            key={i}
            onClick={() => onSelectDay(day)}
            className={`flex flex-col items-center justify-center p-2 rounded-xl transition-all duration-300 transform hover:scale-105
              ${isSelected ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-blue-50 shadow-md'}
              ${today && !isSelected ? 'border-2 border-blue-400 text-blue-700 font-bold' : ''}
              ${isHighlighted ? 'highlight-day' : ''}
              w-full h-24 sm:h-28 text-center
            `}
          >
            <span className="text-xs font-semibold">{getDayName(day)}</span>
            <span className="text-lg font-bold">{day.getDate()}</span>
            <span className="text-xl mt-1">{dayIcon}</span> {/* Display icon */}
            <span className={`text-xs mt-1 px-1 py-0.5 rounded-full font-medium hidden sm:block
              ${dayType === 'Push Day' ? 'bg-red-200 text-red-800' : ''}
              ${dayType === 'Pull Day' ? 'bg-green-200 text-green-800' : ''}
              ${dayType === 'Legs Day' ? 'bg-yellow-200 text-yellow-800' : ''}
              ${dayType === 'Cardio' ? 'bg-purple-200 text-purple-800' : ''}
              ${dayType === 'Active Recovery' ? 'bg-indigo-200 text-indigo-800' : ''}
              ${dayType === 'Rest Day' ? 'bg-gray-200 text-gray-800' : ''}
              ${dayType === 'Custom Workout' ? 'bg-orange-200 text-orange-800' : ''}
            `}>
              {dayType}
            </span>
          </button>
        );
        currentDay = addDays(currentDay, 1);
      }

      return (
        <div className="flex flex-col items-center justify-between mb-6 bg-white p-4 rounded-2xl shadow-xl border border-blue-100">
          <div className="flex w-full justify-between items-center mb-4">
            <button
              onClick={onPrevWeek}
              className="p-3 rounded-full bg-blue-100 hover:bg-blue-200 transition-colors duration-200 shadow-sm hover:shadow-md"
              aria-label="Previous week"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <h3 className="text-xl font-bold text-gray-800">
                Week of {currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
            </h3>
            <button
              onClick={onNextWeek}
              className="p-3 rounded-full bg-blue-100 hover:bg-blue-200 transition-colors duration-200 shadow-sm hover:shadow-md"
              aria-label="Next week"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
          <div className="flex-1 grid grid-cols-7 gap-2 text-center w-full">
            {days}
          </div>
        </div>
      );
    };

    // --- ProgressModal Component ---
    const ProgressModal = ({
      onClose,
      weightChartData,
      getStepsChartData,
      stepsFilter,
      setStepsFilter,
      dailyStepsInput,
      setDailyStepsInput,
      saveDailyProgressForSteps, // Renamed to clarify its purpose
      isChartJsLoaded
    }) => {
      return (
        <div className="modal-overlay">
          <div className="modal-content">
            <button onClick={onClose} className="modal-close-button">
              &times;
            </button>
            <h3 className="text-2xl font-bold text-pink-700 mb-4">Your Progress & Daily Steps</h3>

            {/* Daily Steps Input Field */}
            <div className="mb-6 pb-4 border-b border-blue-100">
              <h4 className="font-bold text-xl text-blue-800 mb-2">Daily Steps</h4>
              <input
                type="number"
                className="border border-blue-300 rounded-md w-full px-3 py-2 text-gray-800 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                placeholder="Enter steps"
                value={dailyStepsInput}
                onChange={(e) => setDailyStepsInput(e.target.value)}
              />
            </div>

            <button
              onClick={() => { saveDailyProgressForSteps(); onClose(); }} /* Save only steps and close */
              className="w-full px-6 py-3 mt-6 bg-blue-600 text-white font-bold rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-300 transform hover:scale-105"
            >
              Save Steps & Close
            </button>

            <hr className="my-8 border-gray-200" />

            {/* Weekly Weight Chart */}
            <div className="mb-8">
              <h4 className="font-semibold text-xl mb-4 text-gray-800">Weekly Total Weight Lifted (kg)</h4>
              {isChartJsLoaded ? (
                weightChartData.labels.length > 0 ? (
                  <div style={{ height: '300px' }}>
                    <ChartComponent
                      type="line"
                      data={weightChartData}
                      options={{
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                          legend: { position: 'top' },
                          title: { display: false }
                        },
                        scales: {
                          y: { beginAtZero: true, title: { display: true, text: 'Total Weight (kg)' } }
                        }
                      }}
                    />
                  </div>
                ) : (
                  <p className="text-gray-500 text-center py-4">No weight data recorded yet.</p>
                )
              ) : (
                <p className="text-gray-500 text-center py-4">Loading charts...</p>
              )}
            </div>

            {/* Daily Steps Chart */}
            <div>
              <h4 className="font-semibold text-xl mb-4 text-gray-800">Daily Steps</h4>
              <div className="flex justify-center space-x-2 mb-4">
                <button
                  onClick={() => setStepsFilter('week')}
                  className={`px-3 py-1 rounded-full text-sm ${stepsFilter === 'week' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  Current Week
                </button>
                <button
                  onClick={() => setStepsFilter('prev-week')}
                  className={`px-3 py-1 rounded-full text-sm ${stepsFilter === 'prev-week' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  Previous Week
                </button>
                <button
                  onClick={() => setStepsFilter('month')}
                  className={`px-3 py-1 rounded-full text-sm ${stepsFilter === 'month' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                  Current Month
                </button>
              </div>
              {isChartJsLoaded ? (
                getStepsChartData(stepsFilter).labels.length > 0 ? (
                  <div style={{ height: '300px' }}>
                    <ChartComponent
                      type="bar"
                      data={getStepsChartData(stepsFilter)}
                      options={{
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                          legend: { position: 'top' },
                          title: { display: false },
                          annotation: {
                            annotations: {
                              line1: {
                                type: 'line', yMin: 10500, yMax: 10500,
                                borderColor: 'rgb(255, 99, 132)', borderWidth: 2, borderDash: [5, 5],
                                label: { content: 'Target: 10,500 Steps', enabled: true, position: 'end', backgroundColor: 'rgba(255, 99, 132, 0.8)', color: 'white', font: { size: 10 } }
                              }
                            }
                          }
                        },
                        scales: {
                          y: { beginAtZero: true, title: { display: true, text: 'Steps' } }
                        }
                      }}
                    />
                  </div>
                ) : (
                  <p className="text-gray-500 text-center py-4">No steps data recorded for this period.</p>
                )
              ) : (
                <p className="text-gray-500 text-center py-4">Loading charts...</p>
              )}
            </div>
          </div>
        </div>
      );
    };

    // --- App Component ---
    const App = () => {
      const today = new Date();
      const [quote, setQuote] = useState('');
      const [selectedDate, setSelectedDate] = useState(today);
      const [currentWeekStart, setCurrentWeekStart] = useState(getStartOfWeek(today));
      const [showCustomizeModal, setShowCustomizeModal] = useState(false);
      const [showProgressModal, setShowProgressModal] = useState(false);
      const [targetMoveDay, setTargetMoveDay] = useState('');
      const [restTimer, setRestTimer] = useState(0);
      const [restTimerVisible, setRestTimerVisible] = useState(false);
      const [isChartJsLoaded, setIsChartJsLoaded] = useState(false); // New state for Chart.js loading
      const [highlightedDate, setHighlightedDate] = useState(null); // New state for highlighting

      const [selectedPlanId, setSelectedPlanId] = useState(() => {
        try {
          return localStorage.getItem('selectedFitnessPlan') || 'ppl_split_plan';
        } catch (e) {
          console.error("Error loading selected plan from localStorage:", e);
          return 'ppl_split_plan';
        }
      });

      const [allWorkoutData, setAllWorkoutData] = useState(() => {
        try {
          return JSON.parse(localStorage.getItem('fitnessTrackerData') || '{}');
        } catch (e) {
          console.error("Error parsing fitnessTrackerData from localStorage:", e);
          return {};
        }
      });

      // Temporary state for current day's steps input
      const [dailyStepsInput, setDailyStepsInput] = useState('');
      // Temporary state for current day's exercise data (deep copy of relevant part of allWorkoutData)
      const [dailyExercisesState, setDailyExercisesState] = useState({});

      // Effect to initialize temporary states when selectedDate changes
      useEffect(() => {
        const dateKey = formatDate(selectedDate);
        const currentDayData = allWorkoutData[dateKey] || {};

        setDailyStepsInput(currentDayData.steps ?? '');

        // Deep copy exercise data for the current day
        const exercisesCopy = {};
        const defaultPlannedExercises = WORKOUT_PLANS[selectedPlanId]?.schedule[getDayName(selectedDate)] || [];
        const customizedExercises = currentDayData.exercises;

        // Determine which set of exercises to use for the current day's display and logging
        const exercisesToLoad = Array.isArray(customizedExercises)
          ? customizedExercises // If explicitly customized (even if empty), use it
          : defaultPlannedExercises; // Otherwise, use the default plan

        exercisesToLoad.forEach(ex => {
            exercisesCopy[ex.id] = {};
            const numSets = ex.sets || (ex.type === 'cardio' ? 1 : 0);
            for (let i = 0; i < numSets; i++) {
                // Copy existing data or initialize
                exercisesCopy[ex.id][`set-${i}`] = {
                    ...(currentDayData[ex.id]?.[`set-${i}`] || { weight: '', completed: false, timer: 0 })
                };
            }
        });
        setDailyExercisesState(exercisesCopy);
      }, [selectedDate, allWorkoutData, selectedPlanId]);

      // Effect to check if Chart.js and its plugin are loaded
      useEffect(() => {
        const checkLibraries = () => {
          if (typeof window.Chart !== 'undefined' && typeof window.ChartAnnotation !== 'undefined') {
            setIsChartJsLoaded(true);
          } else {
            setTimeout(checkLibraries, 100); // Retry after a short delay
          }
        };
        checkLibraries(); // Initial check
      }, []);

      // Effect for highlighting
      useEffect(() => {
        if (highlightedDate) {
          const timer = setTimeout(() => {
            setHighlightedDate(null);
          }, 20000); // 20 seconds
          return () => clearTimeout(timer);
        }
      }, [highlightedDate]);


      // Daily quote effect
      useEffect(() => {
        const savedDate = localStorage.getItem("quote-date");
        const savedQuote = localStorage.getItem("quote-text");
        const formattedToday = formatDate(new Date());

        if (savedDate !== formattedToday || !savedQuote) {
          const newQuote = MOTIVATION_QUOTES[Math.floor(Math.random() * MOTIVATION_QUOTES.length)];
          localStorage.setItem("quote-date", formattedToday);
          localStorage.setItem("quote-text", newQuote);
          setQuote(newQuote);
        } else {
          setQuote(savedQuote);
        }
      }, []);

      // Function to update a set's data in dailyExercisesState
      const updateSetTemp = useCallback((exerciseId, setIndex, field, value) => {
        setDailyExercisesState(prev => {
          const newExState = { ...prev };
          if (!newExState[exerciseId]) newExState[exerciseId] = {};
          if (!newExState[exerciseId][`set-${setIndex}`]) {
            newExState[exerciseId][`set-${setIndex}`] = { weight: '', completed: false, timer: 0 };
          }
          if (field === 'completed') {
            newExState[exerciseId][`set-${setIndex}`].completed = value;
            if (value) {
              newExState[exerciseId][`set-${setIndex}`].timer = 60; // Start timer
              setRestTimer(60); // Set global timer for popup
              setRestTimerVisible(true); // Show popup
            } else {
              newExState[exerciseId][`set-${setIndex}`].timer = 0; // Reset timer
              setRestTimerVisible(false); // Hide popup if unchecked
            }
          } else if (field === 'weight') {
            newExState[exerciseId][`set-${setIndex}`].weight = Number(value);
          } else if (field === 'timer') {
            newExState[exerciseId][`set-${setIndex}`].timer = value;
          }
          return newExState;
        });
      }, []);

      // Function to save daily steps and workout data to localStorage
      const saveDailyProgress = useCallback(() => {
        const dateKey = formatDate(selectedDate);
        const updatedAllData = { ...allWorkoutData };

        // The exercises for the day are already managed by dailyExercisesState and workoutsForSelectedDay
        // We need to ensure that if a day was customized, its 'exercises' array in allWorkoutData is kept.
        // If it was not customized, we don't need to explicitly save the default exercises.
        const currentDayPlannedExercises = WORKOUT_PLANS[selectedPlanId]?.schedule[getDayName(selectedDate)] || [];
        const exercisesToSave = workoutsForSelectedDay; // Use the actual exercises displayed/logged

        const newDayData = {
          steps: dailyStepsInput, // steps from the state, will be saved when "Save Steps" is clicked
          exercises: exercisesToSave, // Store the list of exercises for the day
          ...dailyExercisesState // Merge the exercise-specific data (weights, completed status)
        };

        updatedAllData[dateKey] = newDayData;
        setAllWorkoutData(updatedAllData);
        localStorage.setItem('fitnessTrackerData', JSON.stringify(updatedAllData));
      }, [selectedDate, allWorkoutData, dailyStepsInput, dailyExercisesState, selectedPlanId]);

      // Function to save ONLY daily steps to localStorage (for the modal)
      const saveDailyProgressForSteps = useCallback(() => {
        const dateKey = formatDate(selectedDate);
        const updatedAllData = { ...allWorkoutData };
        if (!updatedAllData[dateKey]) updatedAllData[dateKey] = {};
        updatedAllData[dateKey].steps = dailyStepsInput;
        // Preserve existing exercise data if any
        if (allWorkoutData[dateKey]?.exercises) {
            updatedAllData[dateKey].exercises = allWorkoutData[dateKey].exercises;
        }
        // Preserve existing exercise-specific data if any
        Object.keys(allWorkoutData[dateKey] || {}).forEach(key => {
            if (key !== 'steps' && key !== 'exercises') {
                updatedAllData[dateKey][key] = allWorkoutData[dateKey][key];
            }
        });

        setAllWorkoutData(updatedAllData);
        localStorage.setItem('fitnessTrackerData', JSON.stringify(updatedAllData));
      }, [selectedDate, allWorkoutData, dailyStepsInput]);


      // Timer effect for global rest timer popup
      useEffect(() => {
        let countdownInterval;
        if (restTimerVisible && restTimer > 0) {
          countdownInterval = setInterval(() => {
            setRestTimer(prev => prev - 1);
          }, 1000);
        } else if (restTimer === 0) {
          setRestTimerVisible(false); // Hide popup when timer reaches 0
        }
        return () => clearInterval(countdownInterval);
      }, [restTimer, restTimerVisible]);


      // Calendar navigation handlers
      const goToPreviousWeek = () => {
        setCurrentWeekStart(prev => addDays(prev, -7));
        setSelectedDate(prev => addDays(getStartOfWeek(addDays(prev, -7)), 0)); // Go to Monday of previous week
      };

      const goToNextWeek = () => {
        setCurrentWeekStart(prev => addDays(prev, 7));
        setSelectedDate(prev => addDays(getStartOfWeek(addDays(prev, 7)), 0)); // Go to Monday of next week
      };

      const handleSelectDay = (date) => {
        setSelectedDate(date);
      };

      // Get workouts for the selected day: prioritize custom, then default plan
      const selectedDayName = getDayName(selectedDate);
      const dateKey = formatDate(selectedDate);

      const defaultPlannedWorkouts = WORKOUT_PLANS[selectedPlanId]?.schedule[selectedDayName] || [];
      const customizedWorkouts = allWorkoutData[dateKey]?.exercises;

      // If customizedWorkouts is explicitly an array (even empty), use it.
      // Otherwise, fall back to the default plan.
      const workoutsForSelectedDay = (Array.isArray(customizedWorkouts))
        ? customizedWorkouts
        : defaultPlannedWorkouts;

      // Calculate previous week's corresponding date for auto-fill
      const prevWeekDate = addDays(selectedDate, -7);
      const prevWeekData = allWorkoutData[formatDate(prevWeekDate)] || {};

      const currentWeekNumber = getWeekNumber(currentWeekStart);
      const currentYear = currentWeekStart.getFullYear();

      // Get the workout type for the currently selected day to display at the top
      const currentDayWorkoutType = (() => {
          const customizedExercises = allWorkoutData[dateKey]?.exercises;
          const hasCustomExercises = Array.isArray(customizedExercises) && customizedExercises.length > 0;
          const wasCustomizedButEmpty = Array.isArray(customizedExercises) && customizedExercises.length === 0;

          if (hasCustomExercises) {
              return 'Custom Workout';
          }
          const plannedExercises = WORKOUT_PLANS[selectedPlanId]?.schedule[selectedDayName];
          if (wasCustomizedButEmpty || !plannedExercises || plannedExercises.length === 0) {
              return 'Rest Day';
          }
          switch (selectedDayName) {
              case 'Mon': return 'Push Day';
              case 'Tue': return 'Pull Day';
              case 'Wed': return 'Legs Day';
              case 'Thu': return 'Cardio';
              case 'Fri': return 'Active Recovery';
              case 'Sat':
              case 'Sun': return 'Rest Day';
              default: return 'Workout';
          }
      })();


      // --- Manage Daily Workout Modal Logic ---
      const [addExerciseSearch, setAddExerciseSearch] = useState('');
      const [selectedExerciseToAdd, setSelectedExerciseToAdd] = useState('');

      const filteredExercises = ALL_EXERCISES.filter(ex =>
        ex.name.toLowerCase().includes(addExerciseSearch.toLowerCase()) &&
        !workoutsForSelectedDay.some(w => w.id === ex.id) // Don't show already added exercises
      );

      const handleAddExercise = () => {
        if (selectedExerciseToAdd) {
          const exerciseToAdd = ALL_EXERCISES.find(ex => ex.id === selectedExerciseToAdd);
          if (exerciseToAdd) {
            const updatedExercises = [...workoutsForSelectedDay, exerciseToAdd];
            const updatedAllData = { ...allWorkoutData };
            if (!updatedAllData[dateKey]) updatedAllData[dateKey] = {};
            updatedAllData[dateKey].exercises = updatedExercises;
            setAllWorkoutData(updatedAllData);
            localStorage.setItem('fitnessTrackerData', JSON.stringify(updatedAllData));
            setSelectedExerciseToAdd('');
            setAddExerciseSearch('');
            // Also update the dailyExercisesState to reflect the new exercise immediately
            setDailyExercisesState(prev => ({
                ...prev,
                [exerciseToAdd.id]: {} // Initialize new exercise with empty set data
            }));
          }
        }
      };

      const handleRemoveExercise = (exerciseIdToRemove) => {
        const updatedExercises = workoutsForSelectedDay.filter(ex => ex.id !== exerciseIdToRemove);
        const updatedAllData = { ...allWorkoutData };
        if (!updatedAllData[dateKey]) updatedAllData[dateKey] = {};
        updatedAllData[dateKey].exercises = updatedExercises;
        // Also remove specific exercise data (weights, completed, timers) for the removed exercise
        if (updatedAllData[dateKey][exerciseIdToRemove]) {
            delete updatedAllData[dateKey][exerciseIdToRemove];
        }
        setAllWorkoutData(updatedAllData);
        localStorage.setItem('fitnessTrackerData', JSON.stringify(updatedAllData));
        // Also update the dailyExercisesState to remove the exercise
        setDailyExercisesState(prev => {
            const newExState = { ...prev };
            delete newExState[exerciseIdToRemove];
            return newExState;
        });
      };

      // Handle moving workout to another day
      const handleMoveWorkout = () => {
        const sourceDateKey = formatDate(selectedDate);
        const targetDate = addDays(getStartOfWeek(selectedDate), getDayIndex(targetMoveDay));
        const targetDateKey = formatDate(targetDate);

        if (sourceDateKey === targetDateKey || !targetMoveDay) return; // Cannot move to the same day or no target selected

        const updatedAllData = { ...allWorkoutData };

        // Get data from source day
        const sourceDayData = updatedAllData[sourceDateKey] || {};
        const exercisesToMove = sourceDayData.exercises || [];
        const exerciseSpecificDataToMove = {};
        Object.keys(sourceDayData).forEach(key => {
            if (key !== 'exercises' && key !== 'steps') { // Copy only exercise-specific data
                exerciseSpecificDataToMove[key] = sourceDayData[key];
            }
        });
        const sourceSteps = sourceDayData.steps || 0;


        // Set data to target day
        if (!updatedAllData[targetDateKey]) updatedAllData[targetDateKey] = {};
        // Ensure we don't duplicate exercises if target day already has some
        const existingTargetExercises = updatedAllData[targetDateKey].exercises || [];
        const newExercisesForTarget = exercisesToMove.filter(ex => !existingTargetExercises.some(existingEx => existingEx.id === ex.id));
        updatedAllData[targetDateKey].exercises = [...existingTargetExercises, ...newExercisesForTarget];

        Object.assign(updatedAllData[targetDateKey], exerciseSpecificDataToMove); // Merge exercise data
        updatedAllData[targetDateKey].steps = (updatedAllData[targetDateKey].steps || 0) + sourceSteps; // Add steps

        // Clear data from source day
        updatedAllData[sourceDateKey] = { steps: 0, exercises: [] }; // Clear steps, exercises and exercise data

        setAllWorkoutData(updatedAllData);
        localStorage.setItem('fitnessTrackerData', JSON.stringify(updatedAllData));
        setShowCustomizeModal(false);
        setSelectedDate(targetDate); // Automatically navigate to the target day
        setTargetMoveDay(''); // Reset target day selection
        setHighlightedDate(targetDateKey); // Highlight the target day
      };

      // Handle swapping workouts between two days
      const handleSwapWorkouts = () => {
        const sourceDateKey = formatDate(selectedDate);
        const targetDate = addDays(getStartOfWeek(selectedDate), getDayIndex(targetMoveDay));
        const targetDateKey = formatDate(targetDate);

        if (sourceDateKey === targetDateKey || !targetMoveDay) return; // Cannot swap with the same day or no target selected

        const updatedAllData = { ...allWorkoutData };

        // Store source day's data temporarily
        const tempSourceDayData = updatedAllData[sourceDateKey] || { steps: 0, exercises: [] };
        const tempSourceExercises = tempSourceDayData.exercises;
        const tempSourceSteps = tempSourceDayData.steps;
        const tempSourceExerciseSpecificData = {};
        Object.keys(tempSourceDayData).forEach(key => {
            if (key !== 'exercises' && key !== 'steps') {
                tempSourceExerciseSpecificData[key] = tempSourceDayData[key];
            }
        });

        // Get target day's data
        const targetDayData = updatedAllData[targetDateKey] || { steps: 0, exercises: [] };
        const targetExercises = targetDayData.exercises;
        const targetSteps = targetDayData.steps;
        const targetExerciseSpecificData = {};
        Object.keys(targetDayData).forEach(key => {
            if (key !== 'exercises' && key !== 'steps') {
                targetExerciseSpecificData[key] = targetDayData[key];
            }
        });

        // Apply target day's data to source day
        updatedAllData[sourceDateKey] = {
            steps: targetSteps,
            exercises: targetExercises,
            ...targetExerciseSpecificData
        };

        // Apply source day's data to target day
        updatedAllData[targetDateKey] = {
            steps: tempSourceSteps,
            exercises: tempSourceExercises,
            ...tempSourceExerciseSpecificData
        };

        setAllWorkoutData(updatedAllData);
        localStorage.setItem('fitnessTrackerData', JSON.stringify(updatedAllData));
        setShowCustomizeModal(false);
        setTargetMoveDay(''); // Reset target day selection
        setSelectedDate(targetDate); // Navigate to the target day after swap
        setHighlightedDate(targetDateKey); // Highlight the target day
      };


      // --- Progress Chart Data Aggregation ---
      const getChartData = useCallback(() => {
        const weeklyTotalWeight = {}; // { 'YYYY-WW': totalWeight }
        const dailySteps = {};       // { 'YYYY-MM-DD': steps }

        const sortedDates = Object.keys(allWorkoutData).sort();

        sortedDates.forEach(dateStr => {
          const dataForDay = allWorkoutData[dateStr];
          const date = new Date(dateStr);
          const weekKey = `${date.getFullYear()}-${getWeekNumber(date)}`;

          // Aggregate total weight lifted for the week
          let dayTotalWeight = 0;
          // Use the actual exercises stored for the day, or fallback to the plan
          const exercisesForDay = dataForDay.exercises || WORKOUT_PLANS[selectedPlanId]?.schedule[getDayName(date)] || [];
          exercisesForDay.forEach(ex => {
            if (ex.type !== 'cardio' && ex.sets) {
              for (let i = 0; i < ex.sets; i++) {
                const setKey = `set-${i}`;
                // Access data for the exercise directly from dataForDay[ex.id]
                if (dataForDay[ex.id] && dataForDay[ex.id][setKey] && dataForDay[ex.id][setKey].completed) {
                  dayTotalWeight += (dataForDay[ex.id][setKey].weight || 0) * (ex.reps || 1); // Weight * reps for total volume
                }
              }
            }
          });
          weeklyTotalWeight[weekKey] = (weeklyTotalWeight[weekKey] || 0) + dayTotalWeight;

          // Store daily steps
          if (dataForDay.steps !== undefined) {
            dailySteps[dateStr] = dataForDay.steps;
          }
        });

        // Prepare data for Weekly Weight Chart
        const weightLabels = Object.keys(weeklyTotalWeight).sort();
        const weightDataset = weightLabels.map(key => weeklyTotalWeight[key]);
        const weightChartData = {
          labels: weightLabels,
          datasets: [{
            label: 'Total Weight Lifted (kg)',
            data: weightDataset,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            fill: true,
            tension: 0.3
          }]
        };

        // Prepare data for Steps Chart
        const getStepsChartData = (filter) => {
          let labels = [];
          let data = [];

          const now = new Date();
          const currentYear = now.getFullYear();
          const currentMonth = now.getMonth(); // 0-indexed

          if (filter === 'week') {
            const startOfWeek = getStartOfWeek(now);
            for (let i = 0; i < 7; i++) {
              const date = addDays(startOfWeek, i);
              const dateStr = formatDate(date);
              labels.push(getDayName(date) + ' ' + date.getDate());
              data.push(dailySteps[dateStr] || 0);
            }
          } else if (filter === 'prev-week') {
            const prevWeekStart = addDays(getStartOfWeek(now), -7);
            for (let i = 0; i < 7; i++) {
              const date = addDays(prevWeekStart, i);
              const dateStr = formatDate(date);
              labels.push(getDayName(date) + ' ' + date.getDate());
              data.push(dailySteps[dateStr] || 0);
            }
          } else if (filter === 'month') {
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            for (let i = 1; i <= daysInMonth; i++) {
              const date = new Date(currentYear, currentMonth, i);
              const dateStr = formatDate(date);
              labels.push(date.getDate());
              data.push(dailySteps[dateStr] || 0);
            }
          }

          return {
            labels: labels,
            datasets: [{
              label: 'Steps',
              data: data,
              backgroundColor: '#60a5fa', /* blue-400 */
              borderColor: '#3b82f6',
              borderWidth: 1
            }]
          };
        };

        return { weightChartData, getStepsChartData };
      }, [allWorkoutData, selectedPlanId]);

      const { weightChartData, getStepsChartData } = getChartData();
      const [stepsFilter, setStepsFilter] = useState('week'); // 'week', 'prev-week', 'month'

      return (
        <main className="bg-white rounded-3xl shadow-2xl p-6 space-y-6 border-4 border-blue-200">
          <h1 className="text-4xl font-extrabold text-center text-blue-700 mb-4">
            💪 EmpowerFit Tracker
          </h1>
          <div className="text-center bg-green-100 text-green-800 px-6 py-4 rounded-xl shadow-inner text-lg font-medium italic">
            “{quote}”
          </div>

          {/* Prominent Current Day Display */}
          <div className="text-center bg-blue-100 text-blue-800 px-6 py-3 rounded-xl shadow-md text-xl font-semibold mb-6">
            Today is {selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })} - {currentDayWorkoutType}
          </div>

          <div className="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-2 sm:space-y-0 sm:space-x-4">
            <h2 className="text-2xl font-bold text-gray-800">
              Week {currentWeekNumber} of {currentYear}
            </h2>
            <div className="flex space-x-2">
              <button
                onClick={() => setShowCustomizeModal(true)}
                className="px-4 py-2 bg-purple-500 text-white rounded-full shadow-md hover:bg-purple-600 transition-colors duration-200 text-sm"
              >
                Manage Daily Workout
              </button>
              <button
                onClick={() => setShowProgressModal(true)}
                className="px-4 py-2 bg-pink-500 text-white rounded-full shadow-md hover:bg-pink-600 transition-colors duration-200 text-sm"
              >
                View Progress
              </button>
            </div>
          </div>

          <Calendar
            currentWeekStart={currentWeekStart}
            selectedDate={selectedDate}
            onSelectDay={handleSelectDay}
            onPrevWeek={goToPreviousWeek}
            onNextWeek={goToNextWeek}
            workoutPlans={WORKOUT_PLANS}
            selectedPlanId={selectedPlanId}
            allWorkoutData={allWorkoutData}
            highlightedDate={highlightedDate}
          />

          <section>
            <h2 className="text-2xl font-bold mb-4 text-gray-800">
              Workout Summary for {selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
            </h2>
            <p className="text-gray-600 text-sm mb-4">
              Current Workout: <span className="font-semibold text-blue-700">{WORKOUT_PLANS[selectedPlanId]?.name}</span> (<span className="font-semibold text-blue-700">{currentDayWorkoutType}</span>)
            </p>

            {workoutsForSelectedDay.length === 0 ? (
              <p className="text-gray-500 text-center py-6 text-lg bg-gray-50 rounded-lg shadow-inner">
                No planned workouts for this day. Enjoy your well-deserved rest!
              </p>
            ) : (
              <div className="space-y-4">
                {workoutsForSelectedDay.map(ex => (
                  <div key={ex.id} className="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                    <div className="flex justify-between items-center mb-2">
                      <h3 className="font-bold text-lg text-blue-800">{ex.name}</h3>
                      {ex.videoUrl && (
                        <a
                          href={ex.videoUrl}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-blue-600 hover:text-blue-800 text-sm flex items-center bg-blue-50 px-3 py-1 rounded-full shadow-sm hover:shadow-md transition-all duration-200"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.82V10.18a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z" />
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                          Watch Demo
                        </a>
                      )}
                    </div>

                    {ex.sets && ex.reps && (
                      <p className="text-md font-bold text-indigo-700 bg-indigo-50 px-3 py-1 rounded-md inline-block mb-3">
                        {ex.reps} reps x {ex.sets} sets
                      </p>
                    )}
                    {ex.duration && (
                      <p className="text-md font-bold text-green-700 bg-green-50 px-3 py-1 rounded-md inline-block mb-3">
                        Duration: {ex.duration}
                      </p>
                    )}

                    {(() => {
                      const currentExData = dailyExercisesState[ex.id] || {};
                      const previousExData = prevWeekData[ex.id] || {};

                      const numSets = ex.sets || (ex.type === 'cardio' ? 1 : 0);

                      if (numSets > 0) {
                        return (
                          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-2">
                            {Array.from({ length: numSets }).map((_, i) => {
                              const currentSet = currentExData[`set-${i}`] || {};
                              const previousSet = previousExData[`set-${i}`] || {};

                              const initialWeight = ex.type !== 'cardio' ? (currentSet.weight ?? (previousSet.weight || '')) : '';

                              let weightComparisonIcon = null;
                              if (ex.type !== 'cardio' && currentSet.weight !== undefined && currentSet.weight !== '' && !isNaN(Number(currentSet.weight)) && previousSet.weight !== undefined && previousSet.weight !== '') {
                                const currentWeightNum = Number(currentSet.weight);
                                const previousWeightNum = Number(previousSet.weight);
                                if (currentWeightNum > previousWeightNum) {
                                  weightComparisonIcon = <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 arrow-icon arrow-up" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>;
                                } else if (currentWeightNum < previousWeightNum) {
                                  weightComparisonIcon = <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 arrow-icon arrow-down" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" /></svg>;
                                } else {
                                  weightComparisonIcon = <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 arrow-icon arrow-same" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 9l4-4 4 4m0 6l-4 4-4-4" /></svg>;
                                }
                              }

                              const isSetDisabled = i > 0 && !(dailyExercisesState[ex.id]?.[`set-${i-1}`]?.completed);

                              return (
                                <div key={i} className={`border p-4 rounded-lg space-y-2 text-sm shadow-sm
                                  ${ex.type === 'cardio' ? 'border-green-200 bg-green-50' : 'border-blue-200 bg-blue-50'}`}>
                                  <label className={`block font-medium ${ex.type === 'cardio' ? 'text-green-700' : 'text-blue-700'}`}>
                                    {ex.type === 'cardio' ? 'Completed' : `Set ${i + 1}`}
                                  </label>
                                  {ex.type !== 'cardio' && (
                                    <input
                                      type="number"
                                      className="border border-blue-300 rounded-md w-full px-3 py-2 text-gray-800 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                                      placeholder="Weight (kg)"
                                      value={initialWeight}
                                      onChange={(e) => updateSetTemp(ex.id, i, 'weight', e.target.value)}
                                      disabled={isSetDisabled}
                                    />
                                  )}
                                  {ex.type !== 'cardio' && previousSet.weight !== undefined && previousSet.weight !== '' && (
                                    <p className="text-sm text-gray-600 mt-1 flex items-center">
                                      <span className="font-semibold">Prev:</span> {previousSet.weight}kg {currentSet.weight !== undefined && currentSet.weight !== '' && !isNaN(Number(currentSet.weight)) ? weightComparisonIcon : null}
                                    </p>
                                  )}
                                  <label className="inline-flex items-center text-gray-700 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      className={`form-checkbox h-5 w-5 ${ex.type === 'cardio' ? 'text-green-600' : 'text-blue-600'} rounded focus:ring-current mr-2`}
                                      checked={currentSet.completed || false}
                                      onChange={(e) => updateSetTemp(ex.id, i, 'completed', e.target.checked)}
                                      disabled={isSetDisabled}
                                    />
                                    Completed
                                  </label>
                                </div>
                              );
                            })}
                          </div>
                        );
                      }
                      return null;
                    })()}
                  </div>
                ))}
                <button
                  onClick={saveDailyProgress}
                  className="w-full px-6 py-3 mt-6 bg-green-600 text-white font-bold rounded-full shadow-lg hover:bg-green-700 transition-colors duration-300 transform hover:scale-105"
                >
                  Log Workout
                </button>
              </div>
            )}
          </section>


          {/* Manage Daily Workout Modal */}
          {showCustomizeModal && (
            <div className="modal-overlay">
              <div className="modal-content">
                <button onClick={() => setShowCustomizeModal(false)} className="modal-close-button">
                  &times;
                </button>
                <h3 className="text-2xl font-bold text-blue-700 mb-4">Manage Workout for {selectedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</h3>

                {/* Move/Swap Day Section - MOVED TO TOP */}
                <div className="mb-6 pb-4 border-b border-gray-200">
                  <h4 className="font-semibold text-lg mb-2 text-gray-800">Move or Swap Workout Day:</h4>
                  <p className="text-gray-600 text-sm mb-3">
                    Move all exercises and data from {selectedDate.toLocaleDateString('en-US', { weekday: 'long' })} to another day, or swap with another day's workout.
                  </p>
                  <div className="flex flex-wrap gap-2 mb-4">
                    {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map(day => (
                      <button
                        key={day}
                        onClick={() => setTargetMoveDay(day)}
                        className={`px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200
                          ${targetMoveDay === day ? 'bg-blue-600 text-white shadow-md' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}
                          ${getDayName(selectedDate) === day ? 'opacity-50 cursor-not-allowed' : ''}
                        `}
                        disabled={getDayName(selectedDate) === day}
                      >
                        {day}
                      </button>
                    ))}
                  </div>
                  <div className="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3">
                    <button
                      onClick={handleMoveWorkout}
                      disabled={!targetMoveDay || getDayName(selectedDate) === targetMoveDay}
                      className="flex-1 px-4 py-2 bg-indigo-500 text-white rounded-md shadow-md hover:bg-indigo-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                    >
                      Move to {targetMoveDay || '...'}
                    </button>
                    <button
                      onClick={handleSwapWorkouts}
                      disabled={!targetMoveDay || getDayName(selectedDate) === targetMoveDay}
                      className="flex-1 px-4 py-2 bg-orange-500 text-white rounded-md shadow-md hover:bg-orange-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                    >
                      Swap with {targetMoveDay || '...'}
                    </button>
                  </div>
                </div>

                {/* Current Exercises for the Day */}
                <div className="mb-6">
                  <h4 className="font-semibold text-lg mb-2 text-gray-800">Current Exercises:</h4>
                  {workoutsForSelectedDay.length === 0 ? (
                    <p className="text-gray-500 text-sm">No exercises added for this day yet.</p>
                  ) : (
                    <ul className="space-y-2">
                      {workoutsForSelectedDay.map(ex => (
                        <li key={ex.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-md border border-gray-200">
                          <span className="font-medium">{ex.name}</span>
                          <button
                            onClick={() => handleRemoveExercise(ex.id)}
                            className="text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded-md hover:bg-red-100 transition-colors"
                          >
                            Remove
                          </button>
                        </li>
                      ))}
                    </ul>
                  )}
                </div>

                {/* Add Exercise Section */}
                <div className="mt-6 pt-4 border-t border-gray-200">
                  <h4 className="font-semibold text-lg mb-2 text-gray-800">Add New Exercise:</h4>
                  <input
                    type="text"
                    placeholder="Search exercises..."
                    className="border border-gray-300 rounded-md w-full px-3 py-2 mb-3 focus:ring-blue-500 focus:border-blue-500"
                    value={addExerciseSearch}
                    onChange={(e) => {
                      setAddExerciseSearch(e.target.value);
                      setSelectedExerciseToAdd(''); // Clear selection on search change
                    }}
                  />
                  <select
                    className="border border-gray-300 rounded-md w-full px-3 py-2 mb-3 focus:ring-blue-500 focus:border-blue-500"
                    value={selectedExerciseToAdd}
                    onChange={(e) => setSelectedExerciseToAdd(e.target.value)}
                  >
                    <option value="">Select an exercise</option>
                    {filteredExercises.map(ex => (
                      <option key={ex.id} value={ex.id}>{ex.name}</option>
                    ))}
                  </select>
                  <button
                    onClick={handleAddExercise}
                    disabled={!selectedExerciseToAdd}
                    className="w-full px-4 py-2 bg-blue-500 text-white rounded-md shadow-md hover:bg-blue-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    Add Exercise to Day
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Progress Charts & Daily Log Modal */}
          {showProgressModal && (
            <ProgressModal
              onClose={() => setShowProgressModal(false)}
              weightChartData={weightChartData}
              getStepsChartData={getStepsChartData}
              stepsFilter={stepsFilter}
              setStepsFilter={setStepsFilter}
              dailyStepsInput={dailyStepsInput}
              setDailyStepsInput={setDailyStepsInput}
              saveDailyProgressForSteps={saveDailyProgressForSteps} // Pass the new function
              isChartJsLoaded={isChartJsLoaded} /* Pass the loading status */
            />
          )}

          {/* Global Rest Timer Pop-up */}
          {restTimerVisible && restTimer > 0 && (
            <div className="rest-timer-popup">
              Rest: {restTimer}s
            </div>
          )}
        </main>
      );
    };

    // Ensure the React app renders after the entire document and all scripts are loaded
    window.onload = function() {
      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    };
  </script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(reg => console.log('Service Worker registered:', reg))
          .catch(err => console.warn('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
